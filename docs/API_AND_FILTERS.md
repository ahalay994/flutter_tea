# Документация по API и фильтрам проекта "Tea App"

## API Endpoints

### 1. Tea API (tea_api.dart)

#### GET /tea
**Назначение:** Получение списка чаёв с пагинацией  
**Параметры:**
- page (int) - номер страницы (по умолчанию 1)
- perPage (int) - количество элементов на странице (по умолчанию 10)
- search (string) - текст для поиска
- countries (string) - ID стран через запятую
- types (string) - ID типов через запятую
- appearances (string) - ID внешних видов через запятую
- flavors (string) - ID вкусов через запятую

**Пример запроса:**
```
GET /tea?page=1&perPage=10&search=зелёный&countries=1,2&types=3
```

**Пример ответа:**
```json
{
  "data": [
    {
      "id": 1,
      "name": "Зелёный чай",
      "countryId": 1,
      "typeId": 2,
      "appearanceId": 3,
      "temperature": "80°C",
      "brewingGuide": "<p>Заваривать 3 минуты</p>",
      "weight": "500г",
      "description": "Классический зелёный чай",
      "flavors": [1, 2],
      "images": [
        {
          "id": 1,
          "url": "https://example.com/image.jpg",
          "alt": "Фото чая"
        }
      ]
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "perPage": 10,
    "hasMore": true
  }
}
```

#### POST /tea
**Назначение:** Создание нового чая  
**Тело запроса (CreateTeaDto):**
```json
{
  "name": "Название чая",
  "countryId": 1,
  "typeId": 2,
  "appearanceId": 3,
  "temperature": "80°C",
  "brewingGuide": "<p>Руководство по завариванию</p>",
  "weight": "500г",
  "description": "Описание чая",
  "flavors": [1, 2, 3]
}
```

#### PUT /tea/{id}
**Назначение:** Обновление существующего чая  
**Параметры:** ID чая в URL

#### DELETE /tea/{id}
**Назначение:** Удаление чая  
**Параметры:** ID чая в URL

#### GET /tea/{id}
**Назначение:** Получение конкретного чая по ID  
**Параметры:** ID чая в URL

### 2. Фасетный API (tea_api.dart - метод getFacets)

#### GET /tea/facets
**Назначение:** Получение фасетов (количество чаёв по каждому значению фильтра)  
**Параметры (такие же, как и в основном запросе):**
- search (string) - текст для поиска
- countries (string) - ID стран через запятую
- types (string) - ID типов через запятую
- appearances (string) - ID внешних видов через запятую
- flavors (string) - ID вкусов через запятую

**Пример ответа:**
```json
{
  "countries": [
    {
      "id": 1,
      "name": "Китай",
      "count": 15
    },
    {
      "id": 2,
      "name": "Индия",
      "count": 8
    }
  ],
  "types": [
    {
      "id": 1,
      "name": "Зелёный",
      "count": 12
    },
    {
      "id": 2,
      "name": "Чёрный",
      "count": 11
    }
  ],
  "appearances": [
    {
      "id": 1,
      "name": "Листовой",
      "count": 20
    },
    {
      "id": 2,
      "name": "Пакетированный",
      "count": 3
    }
  ],
  "flavors": [
    {
      "id": 1,
      "name": "Цитрусовый",
      "count": 7
    },
    {
      "id": 2,
      "name": "Ягодный",
      "count": 5
    }
  ]
}
```

## Система фильтрации

### 1. Типы фильтров

#### A. Мультиселект фильтры (TeaFilterDrawer)
**Расположение:** lib/screens/home/widgets/tea_drawer.dart

**Функции:**
- Множественный выбор значений
- Возможность поиска внутри каждого списка
- Постраничная загрузка данных
- Сохранение состояния между сеансами

**Компоненты:**
- `TeaFilterDrawer` - основной виджет
- `_TeaFilterDrawerState` - состояние с логикой

**Типы фильтров:**
1. **Поиск по тексту** (строки 70-80)
   - Поле поиска с иконкой
   - Поиск по названию, описанию, руководству и другим полям

2. **Фильтр по странам** (строки 90-200)
   - ExpansionTile с чекбоксами
   - Поиск внутри списка стран
   - Множественный выбор

3. **Фильтр по типам** (строки 200-310)
   - ExpansionTile с чекбоксами
   - Поиск внутри списка типов
   - Множественный выбор

4. **Фильтр по внешнему виду** (строки 310-420)
   - ExpansionTile с чекбоксами
   - Поиск внутри списка внешних видов
   - Множественный выбор

5. **Фильтр по вкусам** (строки 420-530)
   - ExpansionTile с чекбоксами
   - Поиск внутри списка вкусов
   - Множественный выбор

#### B. Фасетные фильтры (TeaFacetFilterDrawer)
**Расположение:** lib/screens/home/widgets/tea_facet_filter_drawer.dart

**Функции:**
- Отображение количества чаёв для каждого значения
- Возможность видеть, сколько результатов будет по каждому значению
- Более информативный интерфейс
- Постраничная загрузка данных

**Компоненты:**
- `TeaFacetFilterDrawer` - основной виджет
- `_TeaFacetFilterDrawerState` - состояние с логикой

**Типы фильтров:**
1. **Фильтр по странам с фасетами** (строки 100-200)
   - Список стран с количеством чаёв
   - Чекбоксы для выбора
   - Сортировка по количеству

2. **Фильтр по типам с фасетами** (строки 200-300)
   - Список типов с количеством чаёв
   - Чекбоксы для выбора
   - Сортировка по количеству

3. **Фильтр по внешнему виду с фасетами** (строки 300-400)
   - Список внешних видов с количеством чаёв
   - Чекбоксы для выбора
   - Сортировка по количеству

4. **Фильтр по вкусам с фасетами** (строки 400-500)
   - Список вкусов с количеством чаёв
   - Чекбоксы для выбора
   - Сортировка по количеству

### 2. Управление фильтрами

#### A. Хранение параметров
**Класс:** `FilterParamsNotifier`  
**Расположение:** lib/controllers/tea_controller.dart (строки 75-85)

**Методы:**
- `update(Map<String, dynamic> newParams)` - обновление параметров
- `clear()` - очистка параметров
- `state` - текущее состояние (Map<String, dynamic>)

#### B. Тип фильтров
**Класс:** `FilterTypeNotifier`  
**Расположение:** lib/controllers/tea_controller.dart (строки 87-94)

**Перечисление:** `FilterType`  
**Расположение:** lib/utils/filter_type.dart

**Значения:**
- `multiSelect` - мультиселект фильтры
- `facets` - фасетные фильтры

### 3. Применение фильтров

#### A. В TeaFilterDrawer (строки 525-585)
1. Сбор параметров из выбранных значений
2. Обновление `filterParamsProvider`
3. Закрытие drawer
4. Вызов `_loadFirstPage()` в HomeScreen (автоматически через отслеживание изменений)

#### B. В TeaFacetFilterDrawer (строки 380-440)
1. Аналогично TeaFilterDrawer
2. Только заглушка до реализации API фасетов

### 4. Загрузка отфильтрованных данных

#### A. В TeaController (строки 500-620)
**Метод:** `fetchFilteredTeas(Map<String, dynamic> filterParams)`

**Логика:**
1. Проверка статуса подключения
2. При онлайн режиме:
   - Запрос к API с параметрами фильтрации
   - Сохранение данных в локальную базу
   - Преобразование ответа в модели
3. При оффлайн режиме:
   - Запрос к локальной базе с фильтрацией
   - Использование SQL JOIN для связанных таблиц
   - Возврат данных с заполненными именами

#### B. В LocalDatabaseService (строки 410-480)
**Метод:** `getFilteredTeasWithNames(...)`

**SQL запрос:**
```sql
SELECT t.*, 
       c.name as country_name, 
       ty.name as type_name, 
       a.name as appearance_name,
       GROUP_CONCAT(f.name) as flavor_names
FROM teas t
LEFT JOIN countries c ON t.country_id = c.id
LEFT JOIN types ty ON t.type_id = ty.id
LEFT JOIN appearances a ON t.appearance_id = a.id
LEFT JOIN tea_flavors tf ON t.id = tf.tea_id
LEFT JOIN flavors f ON tf.flavor_id = f.id
WHERE [фильтры]
GROUP BY t.id
ORDER BY t.name
LIMIT ? OFFSET ?
```

### 5. Пагинация с фильтрами

#### A. Общее количество с фильтрами
**Метод:** `getTotalTeasCountWithFilters(...)` (строки 482-560)

**SQL запрос:**
```sql
SELECT COUNT(*) FROM teas t
LEFT JOIN countries c ON t.country_id = c.id
LEFT JOIN types ty ON t.type_id = ty.id
LEFT JOIN appearances a ON t.appearance_id = a.id
LEFT JOIN tea_flavors tf ON t.id = tf.tea_id
LEFT JOIN flavors f ON tf.flavor_id = f.id
WHERE [фильтры]
GROUP BY t.id
```

#### B. Работа в HomeScreen
1. `_currentPage` - текущая страница
2. `_hasMore` - есть ли ещё данные
3. `_loadMore()` - загрузка следующей страницы

### 6. Сброс фильтров

#### A. В TeaFilterDrawer (строки 567-585)
1. Очистка всех выбранных значений
2. Очистка провайдера фильтров
3. Закрытие drawer

#### B. В HomeScreen (строки 143-150)
1. Очистка провайдера фильтров
2. Сброс пагинации
3. Загрузка первой страницы

## Система логирования фильтров

### 1. Места с логами

#### A. В TeaFilterDrawer
- При выборе/снятии выбора элементов (строки 150, 250, 350, 450)
- При нажатии "Применить фильтры" (строка 525)
- При обновлении провайдера (строка 555)
- При закрытии drawer (строка 570)

#### B. В HomeScreen
- При загрузке данных (строки 41-88, 91-140)
- При сбросе фильтров (строка 143)

#### C. В TeaController
- При обновлении провайдера (строки 75-85)

### 2. Уровни логов
- `debug` - подробная информация о процессах
- `info` - важные события
- `warning` - потенциальные проблемы
- `error` - ошибки и исключения

## Примеры использования

### 1. Применение фильтров
```
Пользователь открывает drawer
→ Выбирает страну "Китай" и тип "Зелёный"
→ Нажимает "Применить фильтры"
→ Параметры сохраняются в провайдер
→ HomeScreen перезагружает данные
→ Отображаются только зелёные чаи из Китая
```

### 2. Сброс фильтров
```
Пользователь нажимает "Сбросить фильтры"
→ Все фильтры очищаются
→ Провайдер сбрасывается
→ Пагинация сбрасывается
→ Загружается полный список чаёв
```

### 3. Оффлайн режим с фильтрами
```
Пользователь без интернета применяет фильтры
→ Данные запрашиваются из локальной базы
→ Используется SQL с фильтрацией
→ Результат отображается с пагинацией
```