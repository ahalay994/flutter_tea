# Руководство по работе с проектом "Tea App"

## Установка и запуск

### 1. Предварительные требования
- Flutter SDK (версия 3.10.8 или выше)
- Dart SDK (входит в состав Flutter)
- Android Studio или VS Code с Flutter плагинами
- Git

### 2. Клонирование проекта
```bash
git clone <URL_проекта>
cd tea
```

### 3. Установка зависимостей
```bash
flutter pub get
```

### 4. Настройка переменных окружения
Создайте файл `.env` в корне проекта:
```
API_URL=ваш_api_url
APP_NAME=Tea App
```

### 5. Запуск приложения
```bash
flutter run
```

## Основные функции приложения

### 1. Просмотр каталога чаёв
- Откройте приложение
- Главный экран отображает список чаёв
- Используйте pull-to-refresh для обновления данных
- Прокрутите вниз для подгрузки дополнительных данных

### 2. Фильтрация чаёв
#### Мультиселект фильтры:
- Нажмите боковое меню (иконка гамбургера)
- Выберите интересующие фильтры:
  - Страна происхождения
  - Тип чая
  - Внешний вид
  - Вкусы
- Введите текст в поле поиска
- Нажмите "Применить фильтры"
- Список чаёв обновится с учётом фильтров

#### Фасетные фильтры:
- В разработке (API endpoint для фасетов ещё не готов)

### 3. Добавление нового чая
- Нажмите кнопку "+" в правом нижнем углу
- Заполните форму:
  - Название чая
  - Страна происхождения
  - Тип чая
  - Внешний вид
  - Температура заваривания
  - Вес
  - Руководство по завариванию (Rich Text)
  - Описание (Rich Text)
  - Вкусы (множественный выбор)
  - Изображения (множественный выбор)
- Нажмите "Сохранить"

### 4. Просмотр деталей чая
- Нажмите на карточку чая в списке
- Откроется экран с детальной информацией
- Просмотрите изображения в галерее
- Прочитайте описание и руководство по завариванию

### 5. Редактирование чая
- На экране деталей нажмите кнопку редактирования
- Внесите изменения в форму
- Нажмите "Сохранить"

### 6. Удаление чая
- На экране деталей нажмите кнопку удаления
- Подтвердите удаление в диалоге

## Работа в оффлайн режиме

### 1. Определение статуса подключения
- В верхней части экрана отображается индикатор подключения
- Зелёная иконка: подключение есть
- Красная иконка: подключение отсутствует
- Жёлтая иконка: проверка подключения

### 2. Поведение при отсутствии интернета
- Приложение использует локально сохранённые данные
- Работает фильтрация по локальным данным
- Добавление и редактирование недоступны
- При восстановлении подключения происходит синхронизация

### 3. Синхронизация данных
- При подключении к интернету данные автоматически синхронизируются
- Локальные изменения отправляются на сервер
- Новые данные загружаются с сервера

## Структура проекта

### 1. lib/api/ - Классы для работы с API
- `api_client.dart` - базовый класс HTTP-запросов
- `tea_api.dart` - API для работы с чаями
- `country_api.dart` - API для стран
- `type_api.dart` - API для типов
- `appearance_api.dart` - API для внешнего вида
- `flavor_api.dart` - API для вкусов
- `image_api.dart` - API для изображений

### 2. lib/controllers/ - Контроллеры бизнес-логики
- `tea_controller.dart` - основной контроллер

### 3. lib/models/ - Модели данных
- `tea.dart` - модель чая
- `image.dart` - модель изображения

### 4. lib/screens/ - Экраны приложения
- `home/` - главный экран
- `add/` - добавление чая
- `details/` - детали чая
- `edit/` - редактирование чая

### 5. lib/services/ - Сервисы приложения
- `local_database_service.dart` - локальная база данных
- `network_service.dart` - работа с сетью

- `tea_service.dart` - бизнес-логика чаёв

### 6. lib/utils/ - Утилиты
- `app_logger.dart` - логирование
- `ui_helpers.dart` - помощники UI
- `json_utils.dart` - работа с JSON
- `filter_type.dart` - типы фильтров

### 7. lib/widgets/ - Общие виджеты
- `animated_loader.dart` - индикатор загрузки
- `image_gallery_view.dart` - галерея изображений
- `info_chip.dart` - информационный чип

## Управление состоянием

### 1. Riverpod провайдеры
- `teaControllerProvider` - основной контроллер
- `teaListProvider` - список чаёв
- `filteredTeaListProvider` - отфильтрованный список
- `filterParamsProvider` - параметры фильтрации
- `filterTypeProvider` - тип фильтров

### 2. Использование в виджетах
```dart
// В ConsumerWidget
final teaList = ref.watch(teaListProvider);

// В ConsumerStatefulWidget
final teaList = ref.read(teaListProvider);
```

## Работа с фильтрами

### 1. Добавление нового типа фильтра
1. Добавьте поле в `FilterParamsNotifier`
2. Обновите методы в `TeaApi` для поддержки нового параметра
3. Добавьте UI-компонент в `TeaFilterDrawer`
4. Обновите `LocalDatabaseService` для работы с новым фильтром в оффлайн режиме

### 2. Переключение между типами фильтров
В коде можно переключать тип фильтров:
```dart
// Переключение на фасетные фильтры
ref.read(filterTypeProvider.notifier).state = FilterType.facets;

// Переключение на мультиселект фильтры
ref.read(filterTypeProvider.notifier).state = FilterType.multiSelect;
```

## Основные классы и их использование

### 1. TeaModel
```dart
// Создание из API-ответа
final tea = TeaModel.fromResponse(
  response: teaResponse,
  countries: countriesList,
  types: typesList,
  appearances: appearancesList,
  flavors: flavorsList,
);

// Создание для сохранения в базе (с ID вместо названий)
final teaForDb = TeaModel.fromApiResponseForDatabase(
  response: teaResponse,
);

// Создание из локальной базы
final teaFromDb = TeaModel.fromLocalDB(
  id: tea.id,
  name: tea.name,
  countryId: tea.countryId.toString(),
  typeId: tea.typeId.toString(),
  appearanceId: tea.appearanceId.toString(),
  // ... другие параметры
  countries: countriesList,
  types: typesList,
  appearances: appearancesList,
  flavors: flavorsList,
);
```

### 2. Асинхронное получение данных
```dart
// В контроллере
final result = await teaController.fetchFilteredTeas(filterParams);

// В UI (в ConsumerWidget)
final teaListAsync = ref.watch(teaListProvider(1)); // страница 1
```

## Отладка и логирование

### 1. Система логирования
В проекте используется `AppLogger` для централизованного логирования:
```dart
AppLogger.debug('Сообщение отладки');
AppLogger.info('Информационное сообщение');
AppLogger.warning('Предупреждение');
AppLogger.error('Сообщение об ошибке', error: exception, stackTrace: stack);
```

### 2. Места с логами
- `TeaFilterDrawer` - логи выбора фильтров
- `HomeScreen` - логи загрузки данных
- `TeaController` - логи обновления провайдеров
- `LocalDatabaseService` - логи работы с базой данных

## Тестирование

### 1. Запуск тестов
```bash
flutter test
```

### 2. Типы тестов
- Unit тесты для бизнес-логики
- Widget тесты для UI компонентов
- Интеграционные тесты для сценариев использования

## Публикация

### 1. Сборка APK
```bash
flutter build apk
```

### 2. Сборка для других платформ
- iOS: `flutter build ios`
- Web: `flutter build web`
- Windows: `flutter build windows`

## Частые проблемы и решения

### 1. Ошибка при запуске
**Проблема:** `pub get failed`
**Решение:** Проверьте подключение к интернету и версию Flutter

### 2. Ошибка с Riverpod
**Проблема:** `ref.listen can only be used within the build method`
**Решение:** Используйте `ConsumerStatefulWidget` и `Consumer` правильно

### 3. Ошибка с базой данных
**Проблема:** `no such table`
**Решение:** Проверьте, что структура базы данных соответствует ожидаемой

### 4. Ошибка с изображениями
**Проблема:** Изображения не загружаются
**Решение:** Проверьте права доступа и форматы изображений

## Рекомендации по разработке

### 1. Архитектура
- Следуйте паттерну MVVM
- Используйте чистую архитектуру
- Разделяйте ответственность по слоям

### 2. Код
- Используйте Riverpod для управления состоянием
- Пишите читаемый и документированный код
- Следуйте стилю Dart и Flutter

### 3. Тестирование
- Пишите unit тесты для бизнес-логики
- Тестируйте UI компоненты
- Проверяйте работу в оффлайн режиме

### 4. Производительность
- Оптимизируйте SQL запросы
- Используйте эффективное кеширование
- Оптимизируйте работу с изображениями