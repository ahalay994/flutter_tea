# Техническая документация проекта "Tea App"

## Общая информация

**Название проекта:** Tea App  
**Назначение:** Приложение для каталогизации и управления информацией о чае  
**Фреймворк:** Flutter (Dart)  
**Архитектура:** MVVM с использованием Riverpod для управления состоянием  
**Бэкенд:** Supabase, HTTP API

## Структура проекта

```
lib/
├── main.dart                 # Точка входа в приложение
├── api/                      # Классы для работы с API
│   ├── api_client.dart       # Базовый класс для HTTP-запросов
│   ├── tea_api.dart          # API для работы с чаями
│   ├── country_api.dart      # API для работы со странами
│   ├── type_api.dart         # API для работы с типами
│   ├── appearance_api.dart   # API для работы с внешним видом
│   ├── flavor_api.dart       # API для работы с вкусами
│   ├── image_api.dart        # API для работы с изображениями
│   └── dto/                  # Классы для передачи данных
│       └── create_tea_dto.dart
├── controllers/              # Контроллеры бизнес-логики
│   └── tea_controller.dart   # Основной контроллер приложения
├── models/                   # Модели данных
│   ├── tea.dart              # Модель чая
│   └── image.dart            # Модель изображения
├── providers/                # Riverpod-провайдеры
│   ├── metadata_provider.dart # Провайдер метаданных
│   └── connection_status_provider.dart
├── screens/                  # Экраны приложения
│   ├── home/                 # Главный экран
│   │   ├── home_screen.dart  # Основной экран списка чаёв
│   │   └── widgets/          # Виджеты главного экрана
│   │       ├── tea_drawer.dart        # Фильтры (мультиселект)
│   │       ├── tea_facet_filter_drawer.dart # Фильтры (фасетные)
│   │       └── tea_card.dart          # Карточка чая
│   ├── add/                  # Экран добавления
│   │   └── add_screen.dart
│   └── details/              # Экран деталей
│       └── details_screen.dart
├── services/                 # Сервисы приложения
│   ├── tea_service.dart      # Сервис чая
│   ├── local_database_service.dart # Локальная база данных
│   ├── network_service.dart  # Сервис сети
│   ├── supabase_service.dart # Сервис Supabase

├── utils/                    # Утилиты
│   ├── app_logger.dart       # Логирование
│   ├── json_utils.dart       # Утилиты для JSON
│   └── ui_helpers.dart       # Помощники UI
└── widgets/                  # Общие виджеты
    ├── animated_loader.dart  # Анимированный загрузчик
    ├── image_gallery_view.dart # Галерея изображений
    └── info_chip.dart        # Информационные чипы
```

## Основные классы и функции

### 1. tea_controller.dart (строки 1-860)

**Назначение:** Контроллер бизнес-логики приложения, координирует работу между UI, сервисами и API

**Основные классы:**
- `TeaController` (строки 96-860) - основной контроллер
- `FilterParamsNotifier` (строки 75-85) - управление параметрами фильтрации
- `FilterTypeNotifier` (строки 87-94) - управление типом фильтров

**Основные методы:**
- `fetchFullTeas()` (строки 320-440) - получение всех чаёв с пагинацией
- `fetchFilteredTeas()` (строки 500-620) - получение отфильтрованных чаёв
- `getTea()` (строки 623-650) - получение одного чая
- `createTeaWithResponse()` (строки 653-665) - создание чая
- `updateTea()` (строки 668-690) - обновление чая
- `deleteTea()` (строки 693-710) - удаление чая

**Riverpod провайдеры:**
- `teaControllerProvider` (строка 100) - основной провайдер контроллера
- `teaListProvider` (строки 106-109) - список чаёв
- `filteredTeaListProvider` (строки 111-114) - фильтрованный список чаёв
- `filterParamsProvider` (строка 86) - параметры фильтрации
- `filterTypeProvider` (строка 95) - тип фильтров

### 2. tea_drawer.dart (строки 1-600)

**Назначение:** Виджет бокового меню с фильтрами мультиселект

**Основные классы:**
- `TeaFilterDrawer` (строки 11-17) - основной класс
- `_TeaFilterDrawerState` (строки 19-590) - состояние виджета

**Основные методы:**
- `_applyFilters()` (строки 525-565) - применение фильтров
- `_resetFilters()` (строки 567-585) - сброс фильтров
- `_buildCountryFilter()` и другие (строки 90-440) - построение фильтров

### 3. tea_facet_filter_drawer.dart (строки 1-450)

**Назначение:** Виджет бокового меню с фасетными фильтрами

**Основные классы:**
- `TeaFacetFilterDrawer` (строки 11-17) - основной класс
- `_TeaFacetFilterDrawerState` (строки 19-440) - состояние виджета

**Основные методы:**
- `_applyFilters()` (строки 380-420) - применение фильтров
- `_resetFilters()` (строки 422-440) - сброс фильтров

### 4. home_screen.dart (строки 1-310)

**Назначение:** Главный экран приложения с отображением списка чаёв

**Основные классы:**
- `HomeScreen` (строки 11-15) - основной класс
- `_HomeScreenState` (строки 17-310) - состояние виджета

**Основные методы:**
- `_loadFirstPage()` (строки 41-88) - загрузка первой страницы
- `_loadMore()` (строки 91-140) - загрузка дополнительных данных
- `_resetFilters()` (строки 143-150) - сброс фильтров
- `_scrollListener()` (строки 34-39) - слушатель скролла

### 5. tea_api.dart (строки 1-270)

**Назначение:** Класс для работы с API чая

**Основные классы:**
- `TeaApi` (строки 62-270) - основной класс API
- `PaginatedTeaResponse` (строки 11-47) - ответ с пагинацией
- `FacetItem` (строки 239-243) - элемент фасета
- `FacetResponse` (строки 245-255) - ответ фасетов

**Основные методы:**
- `getTeas()` (строки 65-72) - получение всех чаёв
- `getFilteredTeas()` (строки 75-111) - получение отфильтрованных чаёв с пагинацией и поддержкой мульти-тенантности (deviceId) через эндпоинт /device-tea/pagination (также может использоваться для получения всех чаёв с пагинацией без фильтров)
- `saveTea()` (строки 111-140) - сохранение нового чая с поддержкой мульти-тенантности (deviceId) через эндпоинт /device-tea
- `updateTea()` (строки 131-143) - обновление чая
- `deleteTea()` (строки 146-151) - удаление чая
- `getFilteredTeas()` (строки 154-202) - получение отфильтрованных чаёв
- `getFacets()` (строки 205-237) - получение фасетов с поддержкой мульти-тенантности (deviceId) через эндпоинт /device-tea/facets

### 6. local_database_service.dart (строки 1-650)

**Назначение:** Сервис для работы с локальной базой данных SQLite

**Основные методы:**
- `getFilteredTeasWithNames()` (строки 410-480) - получение фильтрованных чаёв с именами
- `getTotalTeasCountWithFilters()` (строки 482-560) - количество чаёв с фильтрами
- `insertTea()` (строки 241-270) - вставка чая
- `getTea()` (строки 272-286) - получение чая
- `getFilteredTeas()` (строки 295-320) - получение отфильтрованных чаёв с пагинацией и поддержкой мульти-тенантности (deviceId) через эндпоинт /device-tea/pagination (также может использоваться для получения всех чаёв с пагинацией без фильтров)

### 7. tea.dart (строки 1-200)

**Назначение:** Модель данных для чая

**Основные классы:**
- `TeaModel` (строки 8-200) - основная модель

**Основные методы:**
- `fromResponse()` (строки 28-70) - создание из API-ответа
- `fromApiResponseForDatabase()` (строки 73-100) - создание для сохранения в базе
- `fromLocalDB()` (строки 103-135) - создание из локальной базы
- `copyWith()` (строки 153-177) - копирование с изменениями

## Используемые библиотеки

### 1. flutter_riverpod
**Назначение:** Управление состоянием приложения
**Используется в:** controllers, screens, services
**Версия:** ^3.2.1

### 2. sqflite
**Назначение:** Локальная база данных SQLite
**Используется в:** services/local_database_service.dart
**Версия:** ^2.3.2

### 3. http
**Назначение:** HTTP-запросы к API
**Используется в:** api/*.dart
**Версия:** ^1.1.0

### 4. flutter_quill
**Назначение:** Редактор Rich Text
**Используется в:** screens/add/add_screen.dart
**Версия:** ^11.5.0

### 5. image_picker
**Назначение:** Выбор изображений
**Используется в:** screens/add/add_screen.dart
**Версия:** ^1.2.1

### 6. connectivity_plus
**Назначение:** Определение статуса подключения
**Используется в:** services/network_service.dart
**Версия:** ^6.0.3

## Система фильтров

### 1. Типы фильтров
- **Мультиселект фильтры** (TeaFilterDrawer): обычные фильтры с возможностью выбора нескольких значений
- **Фасетные фильтры** (TeaFacetFilterDrawer): фильтры с отображением количества результатов

### 2. Компоненты системы фильтров
- **Провайдеры:**
  - `filterParamsProvider` - хранит параметры фильтрации
  - `filterTypeProvider` - хранит текущий тип фильтров
- **Интерфейс:**
  - `TeaFilterDrawer` - основной интерфейс фильтров
  - `TeaFacetFilterDrawer` - фасетный интерфейс фильтров
- **Контроллер:**
  - `TeaController` - обрабатывает фильтры и загружает данные

### 3. Механизм работы фильтров
1. Пользователь выбирает фильтры в drawer
2. Параметры сохраняются в `filterParamsProvider`
3. При изменении параметров вызывается `_loadFirstPage()`
4. В зависимости от параметров вызывается `fetchFilteredTeas()` или `fetchFullTeas()`
5. Результаты отображаются в списке

## Система логирования

### 1. AppLogger
**Файл:** utils/app_logger.dart
**Назначение:** Централизованное логирование событий

**Методы:**
- `AppLogger.debug()` - отладочные сообщения
- `AppLogger.info()` - информационные сообщения
- `AppLogger.warning()` - предупреждения
- `AppLogger.error()` - ошибки

### 2. Места с логами
- **tea_drawer.dart:** Логи выбора фильтров и их применения
- **home_screen.dart:** Логи загрузки данных
- **tea_controller.dart:** Логи обновления провайдера фильтров

### 3. Принципы логирования
- Логи используются для отладки и мониторинга работы приложения
- Для релизных сборок логирование отладочных сообщений может быть отключено
- Важные ошибки и предупреждения всегда логируются для мониторинга стабильности

## Система пагинации

### 1. Механизм
- Используется бесконечный скролл
- При достижении конца списка подгружаются следующие данные
- Страницы загружаются с сервера или из локальной базы

### 2. Классы
- `PaginationResult<T>` (tea_controller.dart:14-27) - результат пагинации
- `_scrollListener()` (home_screen.dart) - слушатель скролла
- `_loadMore()` (home_screen.dart) - загрузка следующей страницы

## Оффлайн режим

### 1. Принцип работы
- При отсутствии интернета данные берутся из локальной базы
- Метаданные (страны, типы, вкусы) также хранятся локально
- При восстановлении соединения происходит синхронизация

### 2. Компоненты
- `NetworkService` - определение статуса подключения
- `LocalDatabaseService` - локальное хранение данных
- `TeaController` - логика переключения между режимами

## Архитектурные паттерны

### 1. MVVM (Model-View-ViewModel)
- **Model:** models/*.dart
- **View:** screens/*/*.dart
- **ViewModel:** controllers/*.dart

### 2. Repository Pattern
- **API слой:** api/*.dart
- **Сервис слой:** services/*.dart
- **Контроллер слой:** controllers/*.dart

### 3. Provider Pattern (Riverpod)
- **Провайдеры:** providers/*.dart, controllers/*.dart
- **Использование:** в виджетах через Consumer/ConsumerWidget

## Особенности реализации

### 1. Работа с изображениями
- Используется кеширование через cached_network_image
- Поддержка нескольких изображений на чай
- Локальное кеширование через image_cache_service

### 2. Работа с Rich Text
- Используется flutter_quill для редактирования
- Поддержка форматирования текста
- Сохранение в формате Delta

### 3. Многоязычность
- Поддержка русского и английского языков
- Использование l10n для локализации

### 4. Адаптивный дизайн
- Поддержка разных размеров экранов
- Использование responsive подходов
- Адаптация элементов интерфейса